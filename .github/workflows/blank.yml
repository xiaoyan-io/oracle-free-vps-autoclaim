name: Oracle Auto VPS Claim

on:
  schedule:
    - cron: "*/10 * * * *"  # æ¯10åˆ†é’Ÿå°è¯•ä¸€æ¬¡
  workflow_dispatch:

jobs:
  claim:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install oci requests

      - name: Create OCI Config and Private Key
        run: |
          mkdir -p ~/.oci
          echo "[DEFAULT]" > ~/.oci/config
          echo "user=${{ secrets.OCI_USER_OCID }}" >> ~/.oci/config
          echo "fingerprint=${{ secrets.OCI_FINGERPRINT }}" >> ~/.oci/config
          echo "key_file=~/.oci/oci_api_key.pem" >> ~/.oci/config
          echo "tenancy=${{ secrets.OCI_TENANCY_OCID }}" >> ~/.oci/config
          echo "region=${{ secrets.OCI_REGION }}" >> ~/.oci/config
          echo "${{ secrets.OCI_API_KEY }}" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem

      - name: Try Claim Free VPS
        run: |
          echo "âš™ï¸ è¿è¡Œ claim.py æˆ–ä½ è‡ªå·±çš„é€»è¾‘" > claim.log
          # ç¤ºä¾‹æµ‹è¯•ä»£ç ï¼ˆè¯·æ›¿æ¢ä¸ºå®é™… claim.py è„šæœ¬ï¼‰
          echo "æ¨¡æ‹Ÿåˆ›å»º VPS ä¸­..." >> claim.log
          sleep 5
          echo "ğŸ‰ æŠ¢æœºè„šæœ¬è¿è¡Œå®Œæˆã€‚" >> claim.log

      - name: Telegram Notify
        if: always()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="âœ… Oracle VPS è‡ªåŠ¨æŠ¢æœºè„šæœ¬æ‰§è¡Œå®Œæˆï¼è¯·æŸ¥çœ‹æ—¥å¿—ç»“æœï½"

      - name: Upload Logs
        uses: actions/upload-artifact@v3
        with:
          name: claim-log
          path: claim.log
