name: Oracle Auto VPS Claim

on:
  schedule:
    - cron: "*/10 * * * *"  # 每10分钟尝试一次
  workflow_dispatch:

jobs:
  claim:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install oci requests

      - name: Create OCI Config and Private Key
        run: |
          mkdir -p ~/.oci
          echo "[DEFAULT]" > ~/.oci/config
          echo "user=${{ secrets.OCI_USER_OCID }}" >> ~/.oci/config
          echo "fingerprint=${{ secrets.OCI_FINGERPRINT }}" >> ~/.oci/config
          echo "key_file=~/.oci/oci_api_key.pem" >> ~/.oci/config
          echo "tenancy=${{ secrets.OCI_TENANCY_OCID }}" >> ~/.oci/config
          echo "region=${{ secrets.OCI_REGION }}" >> ~/.oci/config
          echo "${{ secrets.OCI_API_KEY }}" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem

      - name: Try Claim Free VPS
        run: |
          echo "⚙️ 运行 claim.py 或你自己的逻辑" > claim.log
          # 示例测试代码（请替换为实际 claim.py 脚本）
          echo "模拟创建 VPS 中..." >> claim.log
          sleep 5
          echo "🎉 抢机脚本运行完成。" >> claim.log

      - name: Telegram Notify
        if: always()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="✅ Oracle VPS 自动抢机脚本执行完成！请查看日志结果～"

      - name: Upload Logs
        uses: actions/upload-artifact@v3
        with:
          name: claim-log
          path: claim.log
